<!DOCTYPE html>  <html> <head>   <title>PoolTable.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Array.js.html">                 Array.js.coffee               </a>                                           <a class="source" href="Canvas.js.html">                 Canvas.js.coffee               </a>                                           <a class="source" href="Circle.js.html">                 Circle.js.coffee               </a>                                           <a class="source" href="Line.js.html">                 Line.js.coffee               </a>                                           <a class="source" href="Math.js.html">                 Math.js.coffee               </a>                                           <a class="source" href="Polygon.js.html">                 Polygon.js.coffee               </a>                                           <a class="source" href="PoolTable.html">                 PoolTable.coffee               </a>                                           <a class="source" href="Rectangle.js.html">                 Rectangle.js.coffee               </a>                                           <a class="source" href="Shape.js.html">                 Shape.js.coffee               </a>                                           <a class="source" href="Spring.js.html">                 Spring.js.coffee               </a>                                           <a class="source" href="canvasEvents.js.html">                 canvasEvents.js.coffee               </a>                                           <a class="source" href="circles_scene.js.html">                 circles_scene.js.coffee               </a>                                           <a class="source" href="collisions.js.html">                 collisions.js.coffee               </a>                                           <a class="source" href="particles.js.html">                 particles.js.coffee               </a>                                           <a class="source" href="vec.js.html">                 vec.js.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               PoolTable.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>@module PoolTable</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>= require ./Math
= require ./vec
= require ./collisions
= require ./Line
= require ./Circle</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DRAW_GUIDES         = </span><span class="kc">true</span>
<span class="nv">NUM_BALLS           = </span><span class="mi">16</span>
<span class="nv">BALL_RADIUS         = </span><span class="mi">10</span>
<span class="nv">POCKET_SIZE         = </span><span class="mf">1.02</span>
<span class="nv">JAW_SIZE            = </span><span class="mf">1.4</span>
<span class="nv">DECELARATION        = </span><span class="p">.</span><span class="mi">55</span>
<span class="nv">TABLE_FRICTION      = </span><span class="p">.</span><span class="mi">75</span>
<span class="nv">CUSHION_EFFICIENCY  = </span><span class="mi">1</span>
<span class="nv">CUEING_SCALE        = </span><span class="mi">10</span>
<span class="nv">BALL_COLORS         = </span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;#00DD00&#39;</span><span class="p">,</span> <span class="s1">&#39;maroon&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;#00DD00&#39;</span><span class="p">,</span> <span class="s1">&#39;maroon&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]</span>

<span class="nb">Array</span><span class="o">::</span><span class="nv">remove = </span><span class="nf">(e) -&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">t</span><span class="p">..</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="p">(</span><span class="nv">t = </span><span class="nx">@indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>the pool table object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">PoolTable = </span><span class="nf">(ctxt, opts) -&gt;</span>
  <span class="nv">context = </span><span class="nx">ctxt</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Set game params from options or defaults</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cw                = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">width</span>
  <span class="nv">ch                = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">height</span>
  <span class="nv">tableSize         = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">tableSize</span>
  <span class="nv">ballRadius        = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">ballRadius</span> <span class="o">?</span> <span class="nx">BALL_RADIUS</span>
  <span class="nv">pocketSize        = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">pocketSize</span> <span class="o">?</span> <span class="nx">POCKET_SIZE</span>
  <span class="nv">jawSize           = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">jawSize</span> <span class="o">?</span> <span class="nx">JAW_SIZE</span>
  <span class="nv">frictionDecelaration = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">decelaration</span> <span class="o">?</span> <span class="nx">DECELARATION</span>
  <span class="nv">kineticFriction   = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">kineticFriction</span> <span class="o">?</span> <span class="nx">TABLE_FRICTION</span>
  <span class="nv">cushionEfficiency = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">efficiency</span> <span class="o">?</span> <span class="nx">CUSHION_EFFICIENCY</span>
  <span class="nv">onEndTurnCb       = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">onEndTurn</span>
  <span class="nv">onCollisionCb     = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">onCollision</span>
  <span class="nv">cueImg    = </span><span class="kc">null</span>
  <span class="nv">cuePos    = </span><span class="kc">null</span>
  <span class="nv">cueRot    = </span><span class="mi">0</span>
  <span class="nv">cueRotDegrees = </span><span class="mi">0</span>
  <span class="nv">lastCuePos = </span><span class="kc">null</span>
  <span class="nv">cueLen = </span><span class="mi">0</span>
  <span class="nv">cueVec          = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="nv">cueCenterOffset = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="nv">cueStartTime = </span><span class="mi">0</span>
  <span class="nv">cueing    = </span><span class="kc">false</span>
  <span class="nv">balls     = </span><span class="p">[]</span>
  <span class="nv">cushions  = </span><span class="p">[]</span>
  <span class="nv">jaws      = </span><span class="p">[]</span>
  <span class="nv">pockets   = </span><span class="p">[]</span>
  <span class="nv">allpockets = </span><span class="p">[]</span>
  
  <span class="nv">jawArcRadius = </span><span class="mi">0</span>
  <span class="nv">xoffset   = </span><span class="nx">cw</span> <span class="err">/ 4</span>
  <span class="nv">yoffset   = </span><span class="mi">100</span>
  <span class="nv">voff      = </span><span class="kc">null</span>
  <span class="nv">ticks = </span><span class="mi">0</span>
  <span class="nv">lastTime = </span><span class="mi">0</span>
  <span class="nv">animating = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>turn based state vars</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shooting            = </span><span class="kc">false</span>
  <span class="nv">pocketedOnTurn      = </span><span class="p">[]</span>
  <span class="nv">playerColors        = </span><span class="p">{}</span>
  <span class="nv">currentPlayer       = </span><span class="kc">null</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>setup</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setup = </span><span class="o">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;setting up game objects&quot;</span>
    <span class="nv">rs = </span><span class="nx">ballRadius</span> <span class="o">*</span> <span class="nx">pocketSize</span>
    <span class="nv">rd = </span><span class="nx">ballRadius</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="nx">pocketSize</span> <span class="c1"># side separation of a corner pocket</span>
    
    <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Table size: #{tableSize}\nball radius: #{ballRadius}\npocket size: #{pocketSize}\njaw size: #{jawSize}&quot;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;rs: #{rs}, rd: #{rd}&quot;</span>
    <span class="nv">wallOpts = </span><span class="p">{</span><span class="nv">mass: </span><span class="kc">Infinity</span><span class="p">,</span> <span class="nv">efficiency: </span><span class="nx">cushionEfficiency</span><span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Make table cushions
Assuming the table is aligned vertically, major axis is height</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">cushions = </span><span class="p">[</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">-</span><span class="nx">rd</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">wallOpts</span><span class="p">)</span> <span class="c1"># top</span>
      <span class="p">,</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">-</span><span class="nx">rd</span><span class="o">-</span><span class="nx">rs</span><span class="p">,</span> <span class="nx">wallOpts</span><span class="p">)</span> <span class="c1"># left top</span>
      <span class="p">,</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">+</span><span class="nx">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">-</span><span class="nx">rd</span><span class="o">-</span><span class="nx">rs</span><span class="p">,</span> <span class="nx">wallOpts</span><span class="p">)</span> <span class="c1"># left bottom</span>
      <span class="p">,</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">rd</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">-</span><span class="nx">rd</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">wallOpts</span><span class="p">)</span> <span class="c1"># bottom</span>
      <span class="p">,</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">tableSize</span><span class="p">,</span> <span class="nx">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">-</span><span class="nx">rd</span><span class="o">-</span><span class="nx">rs</span><span class="p">,</span> <span class="nx">wallOpts</span><span class="p">)</span> <span class="c1"># right top</span>
      <span class="p">,</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">tableSize</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">+</span><span class="nx">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">-</span><span class="nx">rd</span><span class="o">-</span><span class="nx">rs</span><span class="p">,</span> <span class="nx">wallOpts</span><span class="p">)</span> <span class="c1"># right bottom</span>
    <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Offset cushions from canvas border so that lines draw correctly</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">voff = </span><span class="nx">$V</span><span class="p">([</span><span class="nx">xoffset</span><span class="p">,</span> <span class="nx">yoffset</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="nx">wall</span> <span class="k">in</span> <span class="nx">cushions</span>
      <span class="nv">wall.pos = </span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">voff</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>pw is the radius of the circular arcs at the pocket entrances</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">pw = </span><span class="nx">ballRadius</span> <span class="o">*</span> <span class="nx">pocketSize</span> <span class="err">/ 2</span>

    <span class="nv">createPocket = </span><span class="nf">(v) -&gt;</span>
      <span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">v</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="nv">radius: </span><span class="nx">ballRadius</span> <span class="o">*</span> <span class="nx">pocketSize</span><span class="p">,</span> <span class="nv">mass: </span><span class="kc">Infinity</span><span class="p">,</span> <span class="nv">speed: </span><span class="mi">0</span><span class="p">})</span>
      
    <span class="nv">createJaw = </span><span class="nf">(v, orientation) -&gt;</span>
      <span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">v</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="nv">radius: </span><span class="nx">ballRadius</span> <span class="err">/ 2, mass: Infinity, speed: 0})</span>
     </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Use walls as guide to create jaws</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">wall</span> <span class="k">in</span> <span class="nx">cushions</span>
      <span class="k">if</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">vec</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># this is a vertical wall</span>
        <span class="k">if</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">tableSize</span><span class="err">/2 # its on the right</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">pw</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;v&#39;</span><span class="p">)</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">vec</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">pw</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;v&#39;</span><span class="p">)</span>
        <span class="k">else</span> <span class="c1"># its on the left</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">pw</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;v&#39;</span><span class="p">)</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">vec</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">pw</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;v&#39;</span><span class="p">)</span>
      <span class="k">else</span> <span class="c1"># this is a horizontal wall</span>
        <span class="k">if</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">tableSize</span> <span class="c1"># its on the bottom</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pw</span><span class="p">)),</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">vec</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pw</span><span class="p">)),</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="k">else</span> <span class="c1"># its on the top</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pw</span><span class="p">)),</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
          <span class="nx">jaws</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createJaw</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">vec</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pw</span><span class="p">)),</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Create the pockets</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">xx = </span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tableSize</span>
    <span class="nv">sideOffset = </span><span class="nx">ballRadius</span> <span class="o">*</span> <span class="mi">2</span><span class="o">/</span><span class="mi">3</span>
    <span class="nv">b = </span><span class="mi">2</span>
    <span class="nx">pockets</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createPocket</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">xoffset</span><span class="o">-</span><span class="nx">b</span><span class="p">,</span> <span class="nx">yoffset</span><span class="o">-</span><span class="nx">b</span><span class="p">))</span> <span class="c1"># left top</span>
    <span class="nx">pockets</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createPocket</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">xx</span><span class="o">+</span><span class="nx">b</span><span class="p">,</span> <span class="nx">yoffset</span><span class="o">-</span><span class="nx">b</span><span class="p">))</span> <span class="c1"># right top</span>
    <span class="nx">pockets</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createPocket</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">xoffset</span><span class="o">-</span><span class="nx">sideOffset</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">+</span><span class="nx">yoffset</span><span class="p">))</span>  <span class="c1">#m middle left</span>
    <span class="nx">pockets</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createPocket</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">xx</span><span class="o">+</span><span class="nx">sideOffset</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">+</span><span class="nx">yoffset</span><span class="p">))</span> <span class="c1"># middle right</span>
    <span class="nx">pockets</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createPocket</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">xoffset</span><span class="o">-</span><span class="nx">b</span><span class="p">,</span> <span class="nx">yoffset</span><span class="o">+</span><span class="nx">b</span><span class="o">+</span><span class="nx">tableSize</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># left bottom</span>
    <span class="nx">pockets</span><span class="p">.</span><span class="nx">push</span> <span class="nx">createPocket</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">xx</span><span class="o">+</span><span class="nx">b</span><span class="p">,</span> <span class="nx">yoffset</span><span class="o">+</span><span class="nx">b</span><span class="o">+</span><span class="nx">tableSize</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># right bottom</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Save copy of all pocket shapes for collision detection function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">allpockets = </span><span class="nx">jaws</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">pockets</span>
    </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Make balls</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">createBalls</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Make pool cue</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">createCue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Turn on animation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toggleAnimation</span><span class="p">()</span>
    
  <span class="nv">cuestartPos = </span><span class="o">-&gt;</span>
    <span class="nx">$V</span><span class="p">([</span><span class="nx">tableSize</span><span class="err">/2, 2*tableSize/5, 0]).add(voff)</span>
    
  <span class="nv">createBalls = </span><span class="o">-&gt;</span>
    <span class="nv">r = </span><span class="nx">ballRadius</span> <span class="o">*</span> <span class="mf">1.02</span> <span class="c1"># Add space between racked balls for initial collision resolutions</span>
    <span class="nv">y = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="nx">r</span>
    <span class="nv">tristart = </span><span class="nx">$V</span><span class="p">([</span><span class="nx">tableSize</span><span class="err">/2, tableSize*3/2, 0]).add(voff)</span>
     </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Racked ball positions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ballPosition = </span><span class="nf">(i) -&gt;</span>
      <span class="k">switch</span> <span class="nx">i</span>
        <span class="k">when</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">cuestartPos</span><span class="p">()</span>
        <span class="k">when</span> <span class="mi">2</span> <span class="k">then</span> <span class="nx">tristart</span>
        <span class="k">when</span> <span class="mi">3</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="o">-</span><span class="nx">r</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">4</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="nx">r</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">5</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">6</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">7</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">8</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="o">-</span><span class="nx">r</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">9</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="nx">r</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">10</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="mi">3</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">11</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="mi">4</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">12</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">13</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">14</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">15</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nx">r</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">when</span> <span class="mi">16</span> <span class="k">then</span> <span class="nx">tristart</span><span class="p">.</span><span class="nx">add</span> <span class="nx">$V</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
      
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">NUM_BALLS</span><span class="p">]</span>
      <span class="nv">p = </span><span class="nx">ballPosition</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">))</span>
      <span class="nx">balls</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">p</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">p</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">{</span>
        <span class="nv">radius: </span><span class="nx">ballRadius</span>
        <span class="nv">color: </span><span class="nx">BALL_COLORS</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        
        <span class="nv">speed: </span><span class="mi">0</span>
        <span class="nv">angVel: </span><span class="mi">0</span>
        <span class="nv">efficiency: </span><span class="mi">1</span>
        <span class="nv">pocketed: </span><span class="kc">false</span>
        <span class="nv">moving: </span><span class="kc">false</span>
        <span class="nv">number: </span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span>
        <span class="p">})</span> 
    </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Save original positions for replay</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span>
      <span class="nv">b.origPos = </span><span class="nx">b</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
      
  <span class="nv">createCue = </span><span class="o">-&gt;</span>
    <span class="nv">cueImg = </span><span class="k">new</span> <span class="nx">Image</span>
    <span class="nv">cueImg.src = </span><span class="s1">&#39;/img/poolcue.png&#39;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Convenience point to vector function</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">point = </span><span class="nf">(x, y, z=0) -&gt;</span>
    <span class="nx">$V</span><span class="p">([</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">])</span>
  
  <span class="nv">point2D = </span><span class="nf">(x, y) -&gt;</span>
    <span class="nx">$V</span><span class="p">([</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">])</span>
    
  <span class="nv">drawLine = </span><span class="nf">(line) -&gt;</span>
    <span class="nv">endpoint = </span><span class="nx">line</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">line</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">line</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">lineTo</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
      
  <span class="nv">drawPocket = </span><span class="nf">(j, offset=0) -&gt;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">j</span><span class="p">.</span><span class="nx">x</span><span class="p">()</span><span class="o">-</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">j</span><span class="p">.</span><span class="nx">y</span><span class="p">()</span><span class="o">+</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">j</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">closePath</span><span class="p">()</span>
    
  <span class="nv">drawTable = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Draw the cushions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="nv">context.fillStyle = </span><span class="s1">&#39;#FFFFFF&#39;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cw</span><span class="p">,</span> <span class="nx">ch</span>
    
    <span class="nv">context.fillStyle = </span><span class="s1">&#39;brown&#39;</span>
    <span class="nv">cushionWidth = </span><span class="mi">20</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Draw boundary walls</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nx">cushionWidth</span><span class="p">,</span> <span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nx">cushionWidth</span><span class="p">,</span> 
      <span class="nx">tableSize</span><span class="o">+</span><span class="nx">cushionWidth</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="nx">tableSize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="nx">cushionWidth</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Draw corner rectangles</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">context.fillStyle = </span><span class="s1">&#39;black&#39;</span>
    <span class="nv">cornerw = </span><span class="nx">cushionWidth</span> <span class="o">+</span> <span class="nx">ballRadius</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="nx">pocketSize</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>top left</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nx">cushionWidth</span><span class="p">,</span> <span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nx">cushionWidth</span><span class="p">,</span>
      <span class="nx">cornerw</span><span class="p">,</span> <span class="nx">cornerw</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>top right</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nx">tableSize</span><span class="o">+</span><span class="nx">cushionWidth</span><span class="o">-</span><span class="nx">cornerw</span><span class="p">,</span> 
      <span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nx">cushionWidth</span><span class="p">,</span> 
      <span class="nx">cornerw</span><span class="p">,</span> <span class="nx">cornerw</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>bottom left</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nx">cushionWidth</span><span class="p">,</span> 
      <span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="nx">tableSize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="nx">cushionWidth</span><span class="o">-</span><span class="nx">cornerw</span><span class="p">,</span>
      <span class="nx">cornerw</span><span class="p">,</span> <span class="nx">cornerw</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>bottom right</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nx">tableSize</span><span class="o">+</span><span class="nx">cushionWidth</span><span class="o">-</span><span class="nx">cornerw</span><span class="p">,</span>
      <span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="nx">tableSize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="nx">cushionWidth</span><span class="o">-</span><span class="nx">cornerw</span><span class="p">,</span>
      <span class="nx">cornerw</span><span class="p">,</span> <span class="nx">cornerw</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Draw felt</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">context.fillStyle = </span><span class="s2">&quot;#00aa00&quot;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">tableSize</span><span class="p">,</span> <span class="nx">tableSize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Draw the pocket jaws</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">context.fillStyle = </span><span class="s1">&#39;brown&#39;</span>
    <span class="nv">r = </span><span class="nx">ballRadius</span> <span class="o">*</span> <span class="mf">1.02</span>
    <span class="nv">arcoff = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>arcoff = r/2</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">drawPocket</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span> <span class="nx">arcoff</span><span class="p">)</span> <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">jaws</span>
      </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Draw the pockets</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">context.fillStyle = </span><span class="s1">&#39;black&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>arcoff = r</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">drawPocket</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">arcoff</span><span class="p">)</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">pockets</span>
    </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>fill in side pocket rectangles
side left</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nx">cushionWidth</span><span class="p">,</span> 
      <span class="nx">tableSize</span><span class="o">+</span><span class="nx">yoffset</span><span class="o">-</span><span class="nx">pockets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span><span class="o">-</span><span class="nx">jaws</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span><span class="err">/2,</span>
      <span class="nx">cushionWidth</span><span class="p">,</span> 
      <span class="nx">pockets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="nx">jaws</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span>
      <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>side right</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">voff</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nx">tableSize</span><span class="o">+</span><span class="nx">cushionWidth</span><span class="o">-</span><span class="nx">cushionWidth</span>
      <span class="nx">tableSize</span><span class="o">+</span><span class="nx">yoffset</span><span class="o">-</span><span class="nx">pockets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span><span class="o">-</span><span class="nx">jaws</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span><span class="err">/2,</span>
      <span class="nx">cushionWidth</span><span class="p">,</span> 
      <span class="nx">pockets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="nx">jaws</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">radius</span>
      <span class="p">)</span>
    
    <span class="nx">context</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
      
  <span class="nv">drawBallSpot = </span><span class="nf">(b) -&gt;</span>
    <span class="nv">ps = </span><span class="nx">b</span><span class="p">.</span><span class="nx">spotPos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">spinDir</span><span class="p">).</span><span class="nx">x</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">topspin</span> <span class="err">/ (2 * Math.PI))</span>
    <span class="k">if</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">ballRadius</span>
      <span class="nv">ps = </span><span class="nx">b</span><span class="p">.</span><span class="nx">spotPos</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">ps = </span><span class="nx">ps</span><span class="p">.</span><span class="nx">rotate</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">angVel</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span>
    <span class="nv">b.spotPos = </span><span class="nx">ps</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>newspot = b.pos.add(ps)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">angVel</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">rotate</span> <span class="nx">b</span><span class="p">.</span><span class="nx">angVel</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>context.fillStyle    = '#FFFFFF'
    context.beginPath()
    context.arc(newspot.e(1), newspot.e(2), b.radius/2, 0, Math.PI*2, true);
    context.closePath();
    context.fill();</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawBallNumber = </span><span class="nf">(b) -&gt;</span>
    <span class="nv">s = </span><span class="nx">point</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">radius</span><span class="err">/2, b.radius/2)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Show spinning ball with moving spot
if b.moving
     drawBallSpot(b)</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nv">context.fillStyle    = </span><span class="s1">&#39;#FFFFFF&#39;</span>
    <span class="nv">context.font         = </span><span class="s1">&#39;10px Arial sans-serif&#39;</span>
    <span class="nv">context.textBaseline = </span><span class="s1">&#39;top&#39;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span> <span class="nx">b</span><span class="p">.</span><span class="nx">number</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">()</span><span class="o">-</span><span class="nx">s</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span><span class="p">()</span><span class="o">-</span><span class="nx">s</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
    
  <span class="nv">drawBalls = </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">ball</span> <span class="k">in</span> <span class="nx">balls</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">pocketed</span>
      <span class="nv">context.fillStyle = </span><span class="nx">ball</span><span class="p">.</span><span class="nx">color</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">ball</span><span class="p">.</span><span class="nx">x</span><span class="p">(),</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">y</span><span class="p">(),</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
      <span class="nx">unless</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">number</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nx">drawBallNumber</span><span class="p">(</span><span class="nx">ball</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>TODO: draw spin if applicable</p>             </td>             <td class="code">               <div class="highlight"><pre>      
  <span class="nv">drawCue = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Wait until cue image fully loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">lastCuePos</span><span class="o">?</span> <span class="o">and</span> <span class="nx">cueImg</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">cueImg</span><span class="p">.</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Cue start point relative to ball</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ogCuePos = </span><span class="nx">point</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="nx">cueImg</span><span class="p">.</span><span class="nx">width</span><span class="o">-</span><span class="nx">ballRadius</span><span class="err">/1.5)+cueCenterOffset.e(1), -(cueImg.height+ballRadius/1.5))</span>
        </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>context.fillText "cue angle: #{cueRotDegrees}", 0, 20</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">cueing</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Get offset vector for drawing cue back</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">elapsed = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">cueStartTime</span>
      <span class="nv">yoff = </span><span class="p">(</span><span class="nx">elapsed</span> <span class="err">/ 1000) * 40</span>
      <span class="nv">ogCuePos = </span><span class="nx">ogCuePos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nx">yoff</span><span class="p">))</span>
      
    <span class="nx">context</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">rotate</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">degreesToRadians</span><span class="p">(</span><span class="nx">cueRotDegrees</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">ogCuePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">ogCuePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">cueImg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cueImg</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">cueImg</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nx">DRAW_GUIDES</span> <span class="o">and</span> <span class="nx">lastCuePos</span><span class="o">?</span>
      <span class="nv">cuev = </span><span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">lastCuePos</span><span class="p">).</span><span class="nx">x</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>draw guide line</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">context</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">drawLine</span><span class="p">(</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">cuev</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">cuev</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
  
  <span class="nv">cueAngle = </span><span class="nf">(cuePos) -&gt;</span>
    <span class="nv">v = </span><span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">cuePos</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Adjust angle for vertical cue alignment</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">v</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">)</span> <span class="o">-</span> <span class="mi">90</span>
  
  <span class="nv">displacement = </span><span class="nf">(ts, vel) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">vel</span><span class="o">?</span>
      <span class="nv">foo = </span><span class="mi">0</span>
      <span class="k">throw</span> <span class="s2">&quot;wtf?&quot;</span> 
    <span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="nx">ts</span>
      </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Cue ball angular velocity (horizontal english)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cueAngularVelocity = </span><span class="o">-&gt;</span>
    <span class="nx">cueCenterOffset</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">25</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span>
    </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Cue ball topsin (vertical english)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cueTopspin = </span><span class="o">-&gt;</span>
    <span class="nx">cueCenterOffset</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span>
    </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Moves some shape for some timestep</p>

<p>@param {Shape} s - object to move
@param {Number} ts - timestep</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveObject = </span><span class="nf">(s, ts) -&gt;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">move</span> <span class="nx">displacement</span><span class="p">(</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
      
  <span class="nv">ballIsMoving = </span><span class="nf">(b) -&gt;</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">speed</span> <span class="o">&gt;</span> <span class="nx">Sylvester</span><span class="p">.</span><span class="nx">precision</span>
    
  <span class="nv">ballsMoving = </span><span class="o">-&gt;</span>
    <span class="p">(</span><span class="nx">b</span> <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span> <span class="k">when</span> <span class="nx">ballIsMoving</span><span class="p">(</span><span class="nx">b</span><span class="p">)).</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>returns # non-pocketed balls belonging to a player</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">numBallsInPlay = </span><span class="nf">(player) -&gt;</span>
    <span class="p">(</span><span class="nx">b</span> <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">playerBalls</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="k">when</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">pocketed</span> <span class="o">and</span> <span class="p">(</span><span class="nx">b</span> <span class="o">!=</span> <span class="nx">eightBall</span><span class="p">())).</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>returns all balls belonging to player</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">playerBalls = </span><span class="nf">(player) -&gt;</span> 
    <span class="k">if</span> <span class="nx">playerColors</span><span class="p">[</span><span class="nx">currentPlayer</span><span class="p">]</span>
      <span class="p">(</span><span class="nx">b</span> <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span> <span class="k">when</span> <span class="nx">ballColor</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">==</span> <span class="nx">playerColors</span><span class="p">[</span><span class="nx">currentPlayer</span><span class="p">]</span> <span class="o">and</span> <span class="nx">b</span> <span class="o">!=</span> <span class="nx">eightBall</span><span class="p">())</span>
    <span class="k">else</span> <span class="c1"># return all balls if no one has sunk a ball yet</span>
      <span class="nx">balls</span><span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">NUM_BALLS</span><span class="p">]</span>
      
  <span class="nv">removePocketed = </span><span class="nf">(ball) -&gt;</span>
    <span class="nv">ball.pocketed = </span><span class="kc">true</span>
    <span class="nv">ball.speed = </span><span class="mi">0</span>
    <span class="nv">ball.pos = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nx">pocketedOnTurn</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ball</span>
    
    <span class="k">if</span> <span class="nx">isColorBall</span><span class="p">(</span><span class="nx">ball</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>if first pocketed ball, we need to set the player side</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">playerColors</span><span class="p">[</span><span class="nx">currentPlayer</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>TODO: When more than one color pocketed, 
give player choice or use color with highest count</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">playerColors</span><span class="p">[</span><span class="nx">currentPlayer</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ballColor</span><span class="p">(</span><span class="nx">ball</span><span class="p">)</span>
        <span class="nx">playerColors</span><span class="p">[</span><span class="nx">otherPlayer</span><span class="p">(</span><span class="nx">currentPlayer</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">otherColor</span><span class="p">(</span><span class="nx">ball</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span> <span class="nx">playerColors</span>
    
  <span class="nv">otherPlayer = </span><span class="nf">(player) -&gt;</span>
    <span class="p">(</span><span class="nx">player</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    
  <span class="nv">ballColor = </span><span class="nf">(ball) -&gt;</span>
    <span class="k">if</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">number</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="k">then</span> <span class="s1">&#39;solid&#39;</span> <span class="k">else</span> <span class="s1">&#39;stripe&#39;</span>
    
  <span class="nv">otherColor = </span><span class="nf">(ball) -&gt;</span>
    <span class="k">if</span> <span class="nx">ballColor</span><span class="p">(</span><span class="nx">ball</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;solid&#39;</span> <span class="k">then</span> <span class="s1">&#39;stripe&#39;</span> <span class="k">else</span> <span class="s1">&#39;solid&#39;</span>
    
  <span class="nv">cueBall = </span><span class="o">-&gt;</span>
    <span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="nv">eightBall = </span><span class="o">-&gt;</span>
    <span class="nx">balls</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>

  <span class="nv">isScratched = </span><span class="o">-&gt;</span>
    <span class="nx">cueBall</span><span class="p">().</span><span class="nx">pocketed</span>
  
  <span class="nv">isEightBallScratched = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>TODO: Take current player's color into consideration</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">eightBall</span><span class="p">().</span><span class="nx">pocketed</span> <span class="o">and</span> <span class="p">(</span><span class="nx">numBallsInPlay</span><span class="p">(</span><span class="nx">currentPlayer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    
  <span class="nv">isOwnBallPocketed = </span><span class="o">-&gt;</span>
    <span class="nx">pocketedOnTurn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>last pocketed should be player color</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">ballColor</span><span class="p">(</span><span class="nx">pocketedOnTurn</span><span class="p">[</span><span class="nx">pocketedOnTurn</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nx">playerColors</span><span class="p">[</span><span class="nx">currentPlayer</span><span class="p">]</span>
    
  <span class="nv">isColorBall = </span><span class="nf">(ball) -&gt;</span>
    <span class="nx">ball</span> <span class="o">!=</span> <span class="nx">cueBall</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">ball</span> <span class="o">!=</span> <span class="nx">eightBall</span><span class="p">()</span>
  
  <span class="nv">isGameOver = </span><span class="o">-&gt;</span>
    <span class="nx">eightBall</span><span class="p">().</span><span class="nx">pocketed</span> <span class="o">or</span> 
      <span class="p">(</span><span class="nx">isScratched</span><span class="p">()</span> <span class="o">and</span> <span class="p">(</span><span class="nx">numBallsInPlay</span><span class="p">(</span><span class="nx">currentPlayer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
  
  <span class="nv">isEndOfTurn = </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">shooting</span>
    <span class="nx">isScratched</span><span class="p">()</span> <span class="o">or</span> <span class="o">!</span><span class="nx">isOwnBallPocketed</span><span class="p">()</span> <span class="o">or</span> <span class="nx">eightBall</span><span class="p">().</span><span class="nx">pocketed</span>
  </pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Determines which player won iff game is over</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getWinner = </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">numBallsInPlay</span><span class="p">(</span><span class="nx">currentPlayer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">and</span> <span class="o">!</span><span class="nx">isScratched</span><span class="p">()</span>
      <span class="nx">currentPlayer</span>
    <span class="k">else</span> 
      <span class="nx">otherPlayer</span><span class="p">(</span><span class="nx">currentPlayer</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Returns english applied to cue in both axes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getEnglish = </span><span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">horizontal: </span><span class="nx">cueAngularVelocity</span><span class="p">(),</span> <span class="nv">vertical: </span><span class="nx">cueTopspin</span><span class="p">()}</span>
    
  <span class="nv">resetCueBall = </span><span class="o">-&gt;</span>
    <span class="nv">b = </span><span class="nx">cueBall</span><span class="p">()</span>
    <span class="nv">b.pocketed = </span><span class="kc">false</span>
    <span class="nv">b.pos = </span><span class="nx">cuestartPos</span><span class="p">()</span>
      
  <span class="nv">newGame = </span><span class="o">-&gt;</span>
    <span class="nv">playerColors = </span><span class="p">{}</span>
    
    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span>
      <span class="nv">b.pos = </span><span class="nx">b</span><span class="p">.</span><span class="nx">origPos</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
      <span class="nv">b.pocketed = </span><span class="kc">false</span>
      <span class="nv">b.speed = b.angVel = b.topspin = </span><span class="mi">0</span>
      <span class="nv">b.spinDir = </span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nv">b.spotPos = </span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nv">b.staticFriction = </span><span class="kc">true</span>
      </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Apply linear and kinetic friction to balls (with topspin)
@param {Array} list of balls
@param {Number} res constant air resistance factor reducing linear speed
@param {Number} kinFriction kinetic friction term (only affects motion with spin)
@param {Number} ts current time step</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">applyFrictionToBalls = </span><span class="nf">(balls, res, kinFriction, ts) -&gt;</span>
    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span> <span class="k">when</span> <span class="nx">b</span><span class="p">.</span><span class="nx">moving</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Adjust moving flag in case ball has stopped</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">!</span><span class="nx">ballIsMoving</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">staticFriction</span>
        <span class="nv">b.moving = </span><span class="kc">false</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>apply linear friction term</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">b.speed = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">speed</span> <span class="o">-</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>calculate kinetic friction for balls which are not rolling with static friction</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">staticFriction</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>x topspin = x linear speed
calculate relative vel of ball against table surface</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">spinDiff = </span><span class="nx">b</span><span class="p">.</span><span class="nx">direction</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">speed</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">spinDir</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">topspin</span><span class="p">))</span>
          <span class="nv">friction = </span><span class="nx">spinDiff</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>apply impulse along the line of the spin difference</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">friction</span> <span class="o">&lt;</span> <span class="nx">kinFriction</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>spin matches ball speed - switch to static friction</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">b.staticFriction = </span><span class="kc">true</span>
            <span class="nv">b.topspin = </span><span class="nx">b</span><span class="p">.</span><span class="nx">speed</span>
            <span class="nv">b.spinDir = </span><span class="nx">b</span><span class="p">.</span><span class="nx">direction</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nv">J = </span><span class="nx">spinDiff</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">kinFriction</span><span class="p">).</span><span class="nx">divide</span><span class="p">(</span><span class="nx">friction</span><span class="p">)</span>
            <span class="nv">v = </span><span class="nx">b</span><span class="p">.</span><span class="nx">direction</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">speed</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">J</span><span class="p">)</span>
            <span class="nv">b.speed = </span><span class="nx">v</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">speed</span> <span class="o">&gt;</span> <span class="mi">0</span>
              <span class="nv">b.direction = </span><span class="nx">v</span><span class="p">.</span><span class="nx">toUnitVector</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>decrease amount of topspin</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">spinDiff</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">spinDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
              <span class="nx">b</span><span class="p">.</span><span class="nx">topspin</span> <span class="o">+=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
            <span class="k">else</span>
              <span class="nx">b</span><span class="p">.</span><span class="nx">topspin</span> <span class="o">-=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
        <span class="k">else</span> <span class="c1"># static friction is active - match topspin to speed</span>
          <span class="nv">b.topspin = </span><span class="nx">b</span><span class="p">.</span><span class="nx">speed</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Pool game specific collision detection
@param {Number} timestep since last call <br />
@param {Array} moving objects <br />
@param {Array} fixed objects  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveBalls = </span><span class="nf">(ts, balls, cushions, pockets) -&gt;</span>
    <span class="nx">applyFrictionToBalls</span><span class="p">(</span><span class="nx">balls</span><span class="p">,</span> <span class="nx">frictionDecelaration</span><span class="p">,</span> <span class="nx">kineticFriction</span><span class="p">,</span> <span class="nx">ts</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="s2">&quot;stopped&quot;</span> <span class="nx">unless</span> <span class="nx">ballsMoving</span><span class="p">()</span>
    <span class="nv">ogts = </span><span class="nx">ts</span>
    
    <span class="k">while</span> <span class="nx">ts</span> <span class="o">&gt;</span> <span class="nx">Sylvester</span><span class="p">.</span><span class="nx">precision</span>
      <span class="nv">mn = </span><span class="mi">2</span>
      <span class="nv">ob1 = ob2 = </span><span class="kc">null</span>
      <span class="nv">n = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="nv">collisionNormal = </span><span class="kc">null</span>
      <span class="nv">collisionTime = </span><span class="mi">0</span>
      <span class="nv">tp = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>helper function for checking potential collision and saving 
collisions details if any
@returns {float} collision time if pending collision, else null</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">detectCollisionHelper = </span><span class="nf">(s1, s2, objType) -&gt;</span>
        <span class="nv">s1.velocity = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">direction</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">s1</span><span class="p">.</span><span class="nx">speed</span><span class="p">)</span>
        <span class="nv">s2.velocity = </span><span class="nx">s2</span><span class="p">.</span><span class="nx">direction</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">s2</span><span class="p">.</span><span class="nx">speed</span><span class="p">)</span>
        <span class="nv">s1.displacement = </span><span class="nx">displacement</span><span class="p">(</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
        <span class="nv">s2.displacement = </span><span class="nx">displacement</span><span class="p">(</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>

        <span class="p">[</span><span class="nx">collisionTime</span><span class="p">,</span> <span class="nx">collisionNormal</span><span class="p">]</span> <span class="o">=</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">detectCollision</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span>
        
        <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">isImpendingCollision</span><span class="p">(</span><span class="nx">collisionTime</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>console.log "#{objType} collision in #{collisionTime}!"</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">m = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">mn</span><span class="p">,</span> <span class="nx">collisionTime</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>If collision is most imminent, save objects' info</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">mn</span>
          <span class="nv">mn = </span><span class="nx">m</span>
          <span class="nv">n = </span><span class="nx">collisionNormal</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
          <span class="nv">ob1 = </span><span class="nx">s1</span>
          <span class="nv">ob2 = </span><span class="nx">s2</span>
          <span class="nv">tp = </span><span class="nx">objType</span>
        
        <span class="nx">collisionTime</span>
      </pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Function for resolving ball's linear and angular velocities
when colliding with a cushion
@param {Circle} ball
@param {Line} wall
@param {Vector} normal - normal of collision
@param {Number} cushion efficiency
@param {Number} proportion or angular velocity lost (between 0, 1)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">resolveBallCushionCollision = </span><span class="nf">(ball, cushion, normal, prop) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>angular velocity decreases by some amount phi</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">omega = </span><span class="nx">ball</span><span class="p">.</span><span class="nx">angularVelocity</span><span class="p">()</span>
        <span class="nv">phi = </span><span class="nx">omega</span> <span class="o">*</span> <span class="nx">prop</span>
        <span class="nx">ball</span><span class="p">.</span><span class="nx">setAngularVelocity</span><span class="p">(</span><span class="nx">omega</span> <span class="o">-</span> <span class="nx">phi</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>apply impulse to calculate resulting change in linear velocity
impulse = I<em>phi/radius
I = (ball.mass * ball.radius^2) / 4
change in linear velocity = relative velocity + (I</em>phi/m) * tang
= (ball.radius^2 * phi)/4 * tang</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">tang = </span><span class="nx">normal</span><span class="p">.</span><span class="nx">clockwiseNormal</span><span class="p">()</span>
        <span class="nv">velchange = </span><span class="nx">tang</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="nx">phi</span> <span class="o">*</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">radius</span> <span class="o">*</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">radius</span><span class="p">)</span>
        <span class="nx">ball</span><span class="p">.</span><span class="nx">setVelocity</span> <span class="nx">ball</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">velchange</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>then apply perpendicular impulse as usual</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">collisions</span><span class="p">.</span><span class="nx">resolveInelasticCollisionFixed</span><span class="p">(</span><span class="nx">ball</span><span class="p">,</span> <span class="nx">cushion</span><span class="p">,</span> <span class="nx">normal</span><span class="p">)</span>
        </pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Check each ball for collision</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">balls</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
        <span class="nv">b1 = </span><span class="nx">balls</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="nx">b1</span><span class="p">.</span><span class="nx">pocketed</span>
        </pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>check for collisions between balls</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)...</span><span class="nx">balls</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
          <span class="nv">b2 = </span><span class="nx">balls</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
          <span class="k">continue</span> <span class="k">if</span> <span class="nx">b2</span><span class="p">.</span><span class="nx">pocketed</span>
          
          <span class="k">if</span> <span class="nx">b1</span><span class="p">.</span><span class="nx">moving</span> <span class="o">||</span> <span class="nx">b2</span><span class="p">.</span><span class="nx">moving</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>console.log "detecting collision b/w balls #{b1.number}, #{b2.number}"</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">detectCollisionHelper</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">b2</span><span class="p">,</span> <span class="s2">&quot;ball&quot;</span>
            </pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>check for collisions with cushions    </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">b1</span><span class="p">.</span><span class="nx">moving</span>
          <span class="k">for</span> <span class="nx">w</span> <span class="k">in</span> <span class="nx">cushions</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>console.log "detecting collision b/w ball #{b1.number} and cushion"</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">detectCollisionHelper</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="s2">&quot;wall&quot;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>check for ball pocketing</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">pockets</span>
            <span class="nx">detectCollisionHelper</span><span class="p">(</span><span class="nx">b1</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="s2">&quot;pocket&quot;</span><span class="p">)</span>
              </pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>if there is no collision we are finished</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">break</span> <span class="k">if</span> <span class="nx">mn</span> <span class="o">==</span> <span class="mi">2</span>
      </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>there is a collision
move balls to collision position</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">mn</span> <span class="o">&gt;</span> <span class="nx">Sylvester</span><span class="p">.</span><span class="nx">precision</span>
        <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span> <span class="k">when</span> <span class="nx">b</span><span class="p">.</span><span class="nx">moving</span>
          <span class="nx">moveObject</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">mn</span><span class="o">*</span><span class="nx">ts</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>resolve collisions</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">tp</span> <span class="o">==</span> <span class="s2">&quot;wall&quot;</span>
        <span class="nx">resolveBallCushionCollision</span> <span class="nx">ob1</span><span class="p">,</span> <span class="nx">ob2</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="mf">0.2</span>
        <span class="nv">ob1.speed = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
        <span class="nv">ob1.direction = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">toUnitVector</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">tp</span> <span class="o">==</span> <span class="s2">&quot;pocket&quot;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;pocketing ball #{ob1.number}&quot;</span>
        <span class="nx">removePocketed</span> <span class="nx">ob1</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>console.log "resolving collision b/w #{ob1.number} &amp; #{ob2.number}"
Save collision speed for collision sound playback at proper volume</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">ob1.collided = </span><span class="kc">true</span>
        <span class="nv">ob1.collisionSpeed = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">ob2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">).</span><span class="nx">mag</span><span class="p">()</span>
        
        <span class="nx">collisions</span><span class="p">.</span><span class="nx">resolveCollision</span> <span class="nx">ob1</span><span class="p">,</span> <span class="nx">ob2</span><span class="p">,</span> <span class="nx">n</span>
        <span class="nv">ob1.speed = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
        <span class="nv">ob2.speed = </span><span class="nx">ob2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">ballIsMoving</span><span class="p">(</span><span class="nx">ob1</span><span class="p">)</span>
          <span class="nv">ob1.direction = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">toUnitVector</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">ballIsMoving</span><span class="p">(</span><span class="nx">ob2</span><span class="p">)</span>
          <span class="nv">ob2.direction = </span><span class="nx">ob2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">toUnitVector</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>update ball spins</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">ob1.spinDir = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">direction</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">ob1</span><span class="p">.</span><span class="nx">moving</span>
        <span class="nv">ob2.spinDir = </span><span class="nx">ob2</span><span class="p">.</span><span class="nx">direction</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">ob2</span><span class="p">.</span><span class="nx">moving</span>
        <span class="nv">ob1.staticFriction = ob2.staticFriction = </span><span class="kc">false</span>
        <span class="nv">ob1.moving = ob2.moving = </span><span class="kc">true</span>
        </pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>decrease time and repeat</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">ts</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">mn</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>End while ts > 0</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>move balls for the last section (no collisions)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span>
      <span class="nx">moveObject</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">ts</span><span class="p">)</span> <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">moving</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Use callbacks if any</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">collided</span>
        <span class="nx">onCollisionCb</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">collisionSpeed</span><span class="p">)</span> <span class="k">if</span> <span class="nx">onCollisionCb</span><span class="o">?</span>
        <span class="nv">b.collided = </span><span class="kc">false</span>
    </pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>toggle the animation on and off</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toggleAnimation = </span><span class="o">-&gt;</span>
    <span class="nv">animating = </span><span class="o">!</span><span class="nx">animating</span>
    <span class="nv">lastTime = </span><span class="mi">0</span>
    <span class="nx">tick</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>draw all objects on the canvas</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawScene = </span><span class="o">-&gt;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cw</span><span class="p">,</span> <span class="nx">ch</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Draw table</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">drawTable</span><span class="p">()</span>
    <span class="nx">drawBalls</span><span class="p">()</span>
    <span class="nx">unless</span> <span class="nx">ballsMoving</span><span class="p">()</span>
      <span class="nx">drawCue</span><span class="p">()</span> 
      <span class="nx">shotFinished</span><span class="p">()</span> <span class="k">if</span> <span class="nx">shooting</span>
  </pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>animate all objects</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">animate = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Pass latest timestep to the collision detection function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">timeNow = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">lastTime</span> <span class="o">!=</span> <span class="mi">0</span>
      <span class="nv">elapsed = </span><span class="nx">timeNow</span> <span class="o">-</span> <span class="nx">lastTime</span>
      <span class="nx">moveBalls</span><span class="p">(</span><span class="nx">elapsed</span><span class="err">/1000, balls, cushions, allpockets)</span>
        
    <span class="nv">lastTime = </span><span class="nx">timeNow</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>tick funtion</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tick = </span><span class="o">-&gt;</span>
    <span class="nx">requestAnimFrame</span><span class="p">(</span><span class="nx">tick</span><span class="p">)</span> 
    <span class="nx">drawScene</span><span class="p">()</span>
    <span class="nx">animate</span><span class="p">()</span>
    <span class="nx">ticks</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Initialize</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setup</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Public functions</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">updateCue = </span><span class="nf">(mousePos) -&gt;</span>
    <span class="nv">cueRotDegrees = </span><span class="nx">cueAngle</span><span class="p">(</span><span class="nx">point</span><span class="p">(</span><span class="nx">mousePos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span>
    <span class="nv">lastCuePos = </span><span class="nx">point</span><span class="p">(</span><span class="nx">mousePos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Moves cue left/right from center</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveCue = </span><span class="nf">(dir) -&gt;</span>
    <span class="nv">v = </span><span class="nx">cueCenterOffset</span><span class="p">.</span><span class="nx">elements</span>
    <span class="k">switch</span> <span class="nx">dir</span>
      <span class="k">when</span> <span class="s1">&#39;l&#39;</span> <span class="k">then</span> <span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">when</span> <span class="s1">&#39;r&#39;</span> <span class="k">then</span> <span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">when</span> <span class="s1">&#39;u&#39;</span> <span class="k">then</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">when</span> <span class="s1">&#39;d&#39;</span> <span class="k">then</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
  </pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Making the shot</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initShot = </span><span class="o">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Starting shot...&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Freeze cue direction vector</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">cueVec = </span><span class="nx">balls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">lastCuePos</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">()</span>
    <span class="nv">cueStartTime = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
    <span class="nv">cueing = </span><span class="kc">true</span>
    </pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Shoot!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeShot = </span><span class="nf">(player, cueSpeed) -&gt;</span>
    <span class="nv">cueing = </span><span class="kc">false</span>
    <span class="nv">shooting = </span><span class="kc">true</span>
    <span class="nv">currentPlayer = </span><span class="nx">player</span>
    <span class="nv">pocketedOnTurn = </span><span class="p">[]</span>
    <span class="nv">c = </span><span class="nx">cueBall</span><span class="p">()</span>
    <span class="nv">c.direction = </span><span class="nx">cueVec</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
    <span class="nv">c.spinDir = </span><span class="nx">cueVec</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
    <span class="nv">c.speed = </span><span class="nx">cueSpeed</span>
    <span class="nv">c.moving = </span><span class="kc">true</span>
    <span class="nv">c.staticFriction = </span><span class="kc">false</span>
    <span class="nv">c.angVel = </span><span class="nx">cueAngularVelocity</span><span class="p">()</span>
    <span class="nv">c.topspin = </span><span class="nx">cueTopspin</span><span class="p">()</span>
    <span class="nv">cueCenterOffset = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Setup spin states on other balls</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">balls</span>
      <span class="nv">b.spotPos = </span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">b</span> <span class="o">!=</span> <span class="nx">cueBall</span><span class="p">()</span>
        <span class="nv">b.angVel = </span><span class="mi">0</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;player #{player} shooting with speed: #{cueSpeed}, dir #{cueVec.inspect()}, english: #{c.angVel}&quot;</span>
  
  <span class="nv">shotFinished = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>handle end of turn</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">isEndOfTurn</span><span class="p">()</span>  </pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>use callback if one was provided</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">onEndTurnCb</span><span class="o">?</span>
        <span class="nx">onEndTurnCb</span><span class="p">(</span><span class="nx">playerColors</span><span class="p">)</span> 
      <span class="k">else</span> <span class="k">if</span> <span class="nx">isGameOver</span><span class="p">()</span>
        <span class="nx">newGame</span><span class="p">()</span>
        
    <span class="nx">resetCueBall</span><span class="p">()</span> <span class="k">if</span> <span class="nx">isScratched</span><span class="p">()</span>
    <span class="nv">shooting = </span><span class="kc">false</span>
      </pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Return public functions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">{</span><span class="nx">updateCue</span><span class="p">,</span> <span class="nx">moveCue</span><span class="p">,</span> <span class="nx">initShot</span><span class="p">,</span> <span class="nx">makeShot</span><span class="p">,</span> <span class="nx">newGame</span><span class="p">,</span> <span class="nx">isGameOver</span><span class="p">,</span> <span class="nx">otherPlayer</span><span class="p">,</span> <span class="nx">getWinner</span><span class="p">,</span> <span class="nx">getEnglish</span><span class="p">}</span>

<span class="nv">root = </span><span class="nx">exports</span> <span class="o">?</span> <span class="nb">window</span>
<span class="nv">root.PoolTable = </span><span class="nx">PoolTable</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 