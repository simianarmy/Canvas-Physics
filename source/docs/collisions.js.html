<!DOCTYPE html>  <html> <head>   <title>collisions.js.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Array.js.html">                 Array.js.coffee               </a>                                           <a class="source" href="Canvas.js.html">                 Canvas.js.coffee               </a>                                           <a class="source" href="Circle.js.html">                 Circle.js.coffee               </a>                                           <a class="source" href="Line.js.html">                 Line.js.coffee               </a>                                           <a class="source" href="Math.js.html">                 Math.js.coffee               </a>                                           <a class="source" href="Polygon.js.html">                 Polygon.js.coffee               </a>                                           <a class="source" href="PoolTable.html">                 PoolTable.coffee               </a>                                           <a class="source" href="Rectangle.js.html">                 Rectangle.js.coffee               </a>                                           <a class="source" href="Shape.js.html">                 Shape.js.coffee               </a>                                           <a class="source" href="Spring.js.html">                 Spring.js.coffee               </a>                                           <a class="source" href="canvasEvents.js.html">                 canvasEvents.js.coffee               </a>                                           <a class="source" href="circles_scene.js.html">                 circles_scene.js.coffee               </a>                                           <a class="source" href="collisions.js.html">                 collisions.js.coffee               </a>                                           <a class="source" href="particles.js.html">                 particles.js.coffee               </a>                                           <a class="source" href="vec.js.html">                 vec.js.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               collisions.js.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>collision resolution functions</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>= require ../libs/sylvester</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">collisions = </span><span class="p">(</span><span class="o">-&gt;</span>  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>intersection
Finds the point where 2 lines AB and CD intersect
@returns {Number} time </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">intersection = </span><span class="nf">(a, b, c, d) -&gt;</span>
    <span class="nv">tc1 = </span><span class="nx">b</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">tc2 = </span><span class="nx">b</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">sc1 = </span><span class="nx">c</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">sc2 = </span><span class="nx">c</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">con1 = </span><span class="nx">c</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">con2 = </span><span class="nx">c</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">det = </span><span class="nx">tc2</span> <span class="o">*</span> <span class="nx">sc1</span> <span class="o">-</span> <span class="nx">tc1</span> <span class="o">*</span> <span class="nx">sc2</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">det</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nv">con = </span><span class="nx">tc2</span> <span class="o">*</span> <span class="nx">con1</span> <span class="o">-</span> <span class="nx">tc1</span> <span class="o">*</span> <span class="nx">con2</span>
    <span class="nv">s = </span><span class="nx">con</span> <span class="err">/ det</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">s</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">tc1</span> <span class="o">!=</span> <span class="mi">0</span>
      <span class="p">(</span><span class="nx">con1</span> <span class="o">-</span> <span class="nx">s</span> <span class="o">*</span> <span class="nx">sc1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">tc1</span>
    <span class="k">else</span>
      <span class="p">(</span><span class="nx">con2</span> <span class="o">-</span> <span class="nx">s</span> <span class="o">*</span> <span class="nx">sc2</span><span class="p">)</span> <span class="o">/</span> <span class="nx">tc2</span>
    
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>intersectionTime <br />
@param {Vector} p1 - point1 <br />
@param {Vector} v1 - point1 displacement <br />
@param {Vector} p2 - point2 <br />
@param {Vector} v2 - point2 displacement <br />
@returns {Number} time of intersection</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">intersectionTime = </span><span class="nf">(p1, v1, p2, v2) -&gt;</span>
    <span class="nv">tc1 = </span><span class="nx">v1</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">tc2 = </span><span class="nx">v1</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">sc1 = </span><span class="nx">v2</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">sc2 = </span><span class="nx">v2</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">con1 = </span><span class="nx">p2</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">con2 = </span><span class="nx">p2</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">det = </span><span class="nx">tc2</span> <span class="o">*</span> <span class="nx">sc1</span> <span class="o">-</span> <span class="nx">tc1</span> <span class="o">*</span> <span class="nx">sc2</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">det</span> <span class="o">is</span> <span class="mi">0</span>
    
    <span class="nv">con = </span><span class="nx">sc1</span> <span class="o">*</span> <span class="nx">con2</span> <span class="o">-</span> <span class="nx">sc2</span> <span class="o">*</span> <span class="nx">con1</span>
    <span class="nx">con</span> <span class="err">/ det</span>
    </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>circleCircleCollision
Detect collision between 2 circles <br />
@returns {Array} <br />
  0: {Number} time to collision <br />
  1: {Vector} collision normal</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">circleCircleCollision = </span><span class="nf">(c1, c2) -&gt;</span>
    <span class="nv">w = </span><span class="nx">c1</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">c2</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span>
    <span class="nv">r = </span><span class="nx">c1</span><span class="p">.</span><span class="nx">radius</span> <span class="o">+</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">radius</span>
    <span class="nv">ww = </span><span class="nx">w</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ww</span><span class="o">+</span><span class="nx">Sylvester</span><span class="p">.</span><span class="nx">precision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">r</span><span class="o">*</span><span class="nx">r</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;CIRCLE EMBEDDED&quot;</span>
      <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">EMBEDDED</span>
    
    <span class="nv">v = </span><span class="nx">c1</span><span class="p">.</span><span class="nx">displacement</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">c2</span><span class="p">.</span><span class="nx">displacement</span><span class="p">)</span>
    <span class="nv">a = </span><span class="nx">v</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="nv">b = </span><span class="nx">w</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="nv">c = </span><span class="nx">ww</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nv">root = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">c</span>
    <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span> <span class="k">if</span> <span class="nx">root</span> <span class="o">&lt;</span> <span class="mi">0</span>
    
    <span class="nv">t = </span><span class="p">(</span><span class="o">-</span><span class="nx">b</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">root</span><span class="p">))</span> <span class="o">/</span> <span class="nx">a</span>
    <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span> <span class="nx">unless</span> <span class="nx">isImpendingCollision</span> <span class="nx">t</span>
    
    <span class="nv">collisionNormal = </span><span class="nx">w</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">t</span><span class="p">)).</span><span class="nx">toUnitVector</span><span class="p">()</span>
    <span class="p">[</span><span class="nx">t</span><span class="p">,</span> <span class="nx">collisionNormal</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>circleWallCollision <br />
Detect collision between circle and wall <br />
@returns {Array} <br />
  0: {Number} time to collision <br />
  1: {Vector} collision normal  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">circleWallCollision = </span><span class="nf">(c, wall) -&gt;</span>
    <span class="nv">t = </span><span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span>
    <span class="nv">collisionNormal = </span><span class="kc">null</span>
    <span class="nv">n = </span><span class="nx">wall</span><span class="p">.</span><span class="nx">vec</span><span class="p">.</span><span class="nx">normal</span><span class="p">().</span><span class="nx">toUnitVector</span><span class="p">()</span>
    <span class="nv">oa = </span><span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span>
    <span class="nv">an = </span><span class="nx">oa</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">an</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">radius</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;WALL EMBEDDED&quot;</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">collisions</span><span class="p">.</span><span class="nx">EMBEDDED</span><span class="p">,</span> <span class="nx">n</span><span class="p">]</span>
    
    <span class="nv">r = </span><span class="kc">null</span>
    <span class="nv">v = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="nx">an</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">r = </span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="nx">c</span><span class="p">.</span><span class="nx">radius</span><span class="p">)</span>
      <span class="nv">v = </span><span class="nx">c</span><span class="p">.</span><span class="nx">displacement</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">r = </span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">radius</span><span class="p">)</span>
      <span class="nv">v = </span><span class="nx">c</span><span class="p">.</span><span class="nx">displacement</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="nv">collisionNormal = </span><span class="nx">r</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nx">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1"># moving away from wall</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">t</span><span class="p">,</span> <span class="kc">null</span><span class="p">]</span>
      
    <span class="nv">t = </span><span class="nx">intersectionTime</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">r</span><span class="p">),</span> <span class="nx">c</span><span class="p">.</span><span class="nx">displacement</span><span class="p">,</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">t</span><span class="p">,</span> <span class="nx">collisionNormal</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Detect collision between rotating line and circle
Anglular values must be in radians
@param {Number} theta0 angle of starting position of line from the vertical
@param {Number} omega angular velocity of rotating line
@param {Number} l line length 
@param {Number} r ball radius
@param {Number} d distance of line origin to ball center
@param {Number} alpha angle of vertical and line to ball center 
@param {Number} perpDist perpendicular distance of line from center of rotation
@return {Number} NONE or EMBEDDED or time to collision (if &lt; 1)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">angularCollisionLineCircle = </span><span class="nf">(theta0, omega, l, r, d, alpha, perpDist) -&gt;</span>
    <span class="k">return</span> <span class="nx">collisison</span><span class="p">.</span><span class="nx">NONE</span> <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;</span> <span class="nx">l</span> <span class="o">+</span> <span class="nx">r</span>
    <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">EMBEDDED</span> <span class="k">if</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>k = 1 for clockwise motion, -1 otherwise</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">k = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>move into a  calculation within the range of [0,2pi]</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">alpha</span> <span class="o">-=</span> <span class="nx">theta0</span>
    <span class="k">if</span> <span class="nx">omega</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">omega = </span><span class="o">-</span><span class="nx">omega</span>
      <span class="nv">alpha = </span><span class="o">-</span><span class="nx">alpha</span>
      <span class="nv">k = </span><span class="o">-</span><span class="mi">1</span>
    
    <span class="nv">alpha = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">radRangeAngle</span><span class="p">(</span><span class="nx">alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>check if there is a possible collision.
this means any collision in t > 1 will not be considered.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span> <span class="k">if</span> <span class="nx">alpha</span> <span class="o">&gt;</span> <span class="nx">omega</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>now perform the appropriate collision check</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">d</span><span class="o">*</span><span class="nx">d</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">l</span><span class="o">*</span><span class="nx">l</span> <span class="o">+</span> <span class="nx">r</span><span class="o">*</span><span class="nx">r</span><span class="p">)</span>
      <span class="p">(</span><span class="nx">alpha</span> <span class="o">-</span> <span class="nx">k</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">((</span><span class="nx">r</span><span class="o">-</span><span class="nx">perpDist</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">))</span> <span class="o">/</span> <span class="nx">omega</span>
    <span class="k">else</span>
      <span class="p">(</span><span class="nx">alpha</span> <span class="o">-</span> <span class="nx">k</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">((</span><span class="nx">l</span><span class="o">*</span><span class="nx">l</span> <span class="o">+</span> <span class="nx">d</span><span class="o">*</span><span class="nx">d</span> <span class="o">-</span> <span class="nx">r</span><span class="o">*</span><span class="nx">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">l</span><span class="o">*</span><span class="nx">d</span><span class="p">)))</span> <span class="o">/</span> <span class="nx">omega</span>
      </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Detect collision between rotating line and moving or stationary circle.
This method is quite different than angularCollisionLineCircle() which only 
deals with stationary circles.
From the MPFP CDROM collision simulation Director code. <br />
TODO: Support for cases where the rotating line is offset from its rotating point.
@param {Line} line shape
@param {Circle} circle shape
@param {Number} ts current timestep
@return {Object} 
  t: 0 if collision detected, collisions.NONE if not
  moment1: no idea
  moment2: no idea</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">angularCollisionLineCircle2 = </span><span class="nf">(line, circle, ts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>determine start and end positions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">startPos = </span><span class="nx">circle</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span>
    <span class="nv">endPos = </span><span class="nx">circle</span><span class="p">.</span><span class="nx">locationAfter</span><span class="p">(</span><span class="nx">ts</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">locationAfter</span><span class="p">(</span><span class="nx">ts</span><span class="p">))</span>
    </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>FIXME: HAVING TO USE 90 DEGREE OFFSET SEEMS WRONG HERE!!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">lineStartAng = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">degreesToRadians</span><span class="p">(</span><span class="mi">90</span><span class="o">-</span><span class="nx">line</span><span class="p">.</span><span class="nx">rotation</span><span class="p">)</span>
    <span class="nv">lineAngDisp = </span><span class="nx">line</span><span class="p">.</span><span class="nx">angularVelocity</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nx">ts</span>
    <span class="nv">lineEndAng = </span><span class="nx">lineStartAng</span> <span class="o">+</span> <span class="nx">lineAngDisp</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ball pos: #{startPos.inspect()} - #{endPos.inspect()}&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;line angles: #{lineStartAng} - #{lineEndAng}&quot;</span><span class="p">)</span>
    
    <span class="nv">n1 = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">directionVector</span><span class="p">(</span><span class="nx">lineStartAng</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="err">/2)</span>
    <span class="nv">n2 = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">directionVector</span><span class="p">(</span><span class="nx">lineEndAng</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="err">/2)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>point n1 and n2 towards the initial position of the circle</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">startDist = </span><span class="nx">n1</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">startPos</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">startDist</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">n1 = </span><span class="nx">n1</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">n2 = </span><span class="nx">n2</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="nv">startDist = </span><span class="o">-</span><span class="nx">startDist</span>

    <span class="nv">noColl = </span><span class="p">{</span><span class="nv">t: </span><span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span><span class="p">}</span>
    <span class="nv">r = </span><span class="nx">circle</span><span class="p">.</span><span class="nx">radius</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>NOTE:
Equation can't be solved algebraically - an approximation method must be used
Save time by checking whether it's possible for the 2 objects to collide at all</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <ol>
<li>Check if circle intersects the complete circle swept out by the line</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="p">(</span><span class="nx">startDist</span> <span class="o">-</span> <span class="nx">r</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">endPos</span><span class="p">)</span> <span class="o">-</span> <span class="nx">r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="k">return</span> <span class="nx">noColl</span>
      </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <ol>
<li>Check if angle swept out by the circle during the time interval 
overlaps with the angle swept out by the line.</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="nx">startPos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">n1</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">r</span><span class="p">)).</span><span class="nx">mag</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">endPos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">r</span><span class="p">)).</span><span class="nx">mag</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="nv">t: </span><span class="mi">0</span><span class="p">,</span>
        <span class="nv">normal: </span><span class="nx">n1</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="nv">moment1: </span><span class="nx">$V</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="nv">moment2: </span><span class="nx">startPos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">n1</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">r</span><span class="p">)),</span>
        <span class="nv">ref1: </span><span class="nx">circle</span><span class="p">,</span>
        <span class="nv">ref2: </span><span class="nx">line</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>otherwise, check for intersection with line endpoints
TODO:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">noColl</span>
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Detect collision between rotating line and stationary line
@param {Number} theta0 angle of starting position of line from the vertical
@param {Number} omega angular velocity of rotating line
@param {Line} line1 rotating line object
@param {Line} line2 stationary line object 
@param {Boolean} segment flag: true=checking for endpoints, false=continuous wall
@return {Number} time to collision or NONE</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">angularCollisionLineStationaryLine = </span><span class="nf">(theta0, omega, rline, sline, segment) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Make rotating line pos the origin</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">spos = </span><span class="nx">sline</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">rline</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span>
    <span class="nv">l = </span><span class="nx">rline</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">n = </span><span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">.</span><span class="nx">normal</span><span class="p">().</span><span class="nx">toUnitVector</span><span class="p">()</span>
    <span class="nv">d = </span><span class="nx">spos</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">d = </span><span class="o">-</span><span class="nx">d</span>
      <span class="nv">n = </span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>so n is the normal vector directed towards the point where the perp. from 
the rotating line position meets the stationary line (N)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;</span> <span class="nx">rline</span><span class="p">.</span><span class="nx">length</span> <span class="c1"># too far from wall</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{d} &gt; #{rline.length} - too far from wall!&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span>
    
    <span class="nv">endpt = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>if checking for endpoints, see if they are relevant</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">segment</span>
      <span class="nv">pn = </span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="c1"># vector = rotating line origin P to N</span>
      <span class="nv">dd = </span><span class="nx">l</span><span class="o">*</span><span class="nx">l</span> <span class="o">-</span> <span class="nx">d</span><span class="o">*</span><span class="nx">d</span> <span class="c1"># squared length TD</span>
      <span class="k">if</span> <span class="nx">omega</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">isClockwise</span><span class="p">(</span><span class="nx">spos</span><span class="p">,</span> <span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span>
          <span class="nv">endpt = </span><span class="nx">spos</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span> <span class="c1">#  stationary line point</span>
        <span class="k">else</span>
          <span class="nv">endpt = </span><span class="nx">spos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span> <span class="c1"># endpoint of stationary line</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">isClockwise</span><span class="p">(</span><span class="nx">spos</span><span class="p">,</span> <span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span>
          <span class="nv">endpt = </span><span class="nx">spos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">endpt = </span><span class="nx">spos</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>

      <span class="nv">d1 = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">endpt</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">pn</span><span class="p">).</span><span class="nx">mag</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">d1</span> <span class="o">&lt;</span> <span class="nx">dd</span> <span class="c1"># there is a potential collision with the endpoint</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>a is the angle of collision with the endpoint</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">a = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nx">d</span> <span class="err">/ endpt.mag())</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">isClockwise</span><span class="p">(</span><span class="nx">endpt</span><span class="p">,</span> <span class="nx">pn</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">endpt</span><span class="p">))</span>
          <span class="nv">a = </span><span class="o">-</span><span class="nx">a</span>
      <span class="k">else</span>
        <span class="nv">a = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nx">d</span> <span class="err">/ l)</span>
        <span class="k">if</span> <span class="nx">omega</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nv">a = </span><span class="o">-</span><span class="nx">a</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>check if this collision occurs outside the line segment
ADDING SCALAR TO VECTOR??? WTF DUDE??
BOOK CODE: pn + Math.abs(a) * Math.sqrt(dd) / a
TRYING MULTIPLY INSTEAD...SHEESH</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">ap = </span><span class="nx">pn</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">dd</span><span class="p">)</span> <span class="o">/</span> <span class="nx">a</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>note that abs(a)/a is 1 if a>0, -1 otherwise</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">k = </span><span class="nx">ap</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">spos</span><span class="p">).</span><span class="nx">mag</span><span class="p">()</span> <span class="o">/</span> <span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span> <span class="k">if</span> <span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>end if segment</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>check for collision with an infinite wall</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">a = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nx">d</span> <span class="err">/ l)</span>
      <span class="k">if</span> <span class="nx">omega</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">a = </span><span class="o">-</span><span class="nx">a</span>
          
    <span class="nv">tn = </span><span class="nx">n</span><span class="p">.</span><span class="nx">angleOf</span><span class="p">()</span>
    <span class="nv">someangle = </span><span class="nx">tn</span> <span class="o">-</span> <span class="nx">theta0</span> <span class="o">+</span> <span class="nx">a</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Move angle to range [1, 2pi) doesn't work, need to use range [0, 2pi)..
what about -pi,pi??</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ranged = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">radRangeAngle</span><span class="p">(</span><span class="nx">someangle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">t = </span><span class="nx">ranged</span> <span class="err">/ omega</span>
    
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;n: #{n.inspect()}&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;angle of n: #{tn}&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;theta0: #{theta0}&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;alpha: #{a}&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;total angle: #{someangle}&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ranged: #{ranged}&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;collision if ranged &lt;= #{omega}&quot;</span><span class="p">)</span>    
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;t: #{t}&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">t</span> <span class="o">&gt;</span> <span class="mi">1</span>
    </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If collision on flat, we must make sure the collision is with the line</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">!</span><span class="nx">segment</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>We need vector AT!
Get point PT</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">pt = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">unitVector</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">radRangeAngle</span><span class="p">(</span><span class="nx">a</span><span class="o">+</span><span class="nx">tn</span><span class="p">)).</span><span class="nx">x</span><span class="p">(</span><span class="nx">rline</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;pt: #{pt.inspect()}&quot;</span><span class="p">)</span>
      <span class="nv">oga = </span><span class="nx">spos</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
      <span class="nv">vec = </span><span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">omega</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">isClockwise</span><span class="p">(</span><span class="nx">spos</span><span class="p">,</span> <span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span>
          <span class="nv">oga = </span><span class="nx">spos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">)</span>
          <span class="nv">vec = </span><span class="nx">vec</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>TODO: FIGURE OUT FOR omega &lt;= 0</p>             </td>             <td class="code">               <div class="highlight"><pre>      
      <span class="nv">at = </span><span class="nx">pt</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">oga</span><span class="p">)</span>
      <span class="nv">atv = </span><span class="nx">at</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">vec</span><span class="p">)</span>
      <span class="nv">vmag2 = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">sline</span><span class="p">.</span><span class="nx">vec</span><span class="p">.</span><span class="nx">mag</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;at: #{at.inspect()}, atv: #{atv}, |v|sq = #{vmag2}&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="nx">atv</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">atv</span> <span class="o">&gt;</span> <span class="nx">vmag2</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;collision not on line!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span> 
      
    <span class="nx">t</span>
    </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Detect collision between 2 rotating lines
@param {Line} l1 first line
@param {Line} l2 second line
@param {Number} ts timestep
@return {Number} time to collision or NONE</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">angularCollisionLineLine = </span><span class="nf">(l1, l2, ts) -&gt;</span>
    <span class="nv">angleAfterTimestep = </span><span class="nf">(line) -&gt;</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">radRotation</span><span class="p">()</span> <span class="o">+</span> <span class="nx">line</span><span class="p">.</span><span class="nx">angularVelocity</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nx">ts</span>
    </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>check for potential collision triangle in this timestep</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">theta0 = </span><span class="nx">l1</span><span class="p">.</span><span class="nx">radRotation</span><span class="p">()</span>
    <span class="nv">phi0 = </span><span class="nx">l2</span><span class="p">.</span><span class="nx">radRotation</span><span class="p">()</span>
    
    <span class="nv">k0 = </span><span class="nx">phi0</span> <span class="o">-</span> <span class="nx">theta0</span>
    <span class="nv">k1 = </span><span class="nx">phi0</span> <span class="o">-</span> <span class="nx">theta0</span> <span class="o">+</span> <span class="p">(</span><span class="nx">l2</span><span class="p">.</span><span class="nx">angularVelocity</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">l1</span><span class="p">.</span><span class="nx">angularVelocity</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="nx">unless</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">&lt;=</span> <span class="nx">k0</span> <span class="o">&lt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">&lt;=</span> <span class="nx">k1</span> <span class="o">&lt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span> 
    </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>if triangle is formed correctly, use approximation and sine rule
get angles of the new triangle</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">pq = </span><span class="nx">l2</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">l1</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span>
    <span class="nv">pqu = </span><span class="nx">pq</span><span class="p">.</span><span class="nx">toUnitVector</span><span class="p">()</span>
    <span class="nv">d = </span><span class="nx">pq</span><span class="p">.</span><span class="nx">mag</span><span class="p">()</span>
    
    <span class="nv">l1v = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">unitVector</span><span class="p">(</span><span class="nx">angleAfterTimestep</span><span class="p">(</span><span class="nx">l1</span><span class="p">))</span>
    <span class="nv">l2v = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">unitVector</span><span class="p">(</span><span class="nx">angleAfterTimestep</span><span class="p">(</span><span class="nx">l2</span><span class="p">))</span>
    
    <span class="nv">l1vAngle = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nx">l1v</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">pqu</span><span class="p">))</span>
    <span class="nv">l2vAngle = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nx">l2v</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">pqu</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="nv">beta = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">radRangeAngle</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">-</span> <span class="nx">l1vAngle</span> <span class="o">-</span> <span class="nx">l2vAngle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">precision = </span><span class="mf">0.00005</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;beta: #{beta}, d: #{d}&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Need length PR or QR calculated from triangle
Use law of cosines for each side</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">l2len = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">d</span><span class="o">*</span><span class="nx">d</span> <span class="o">+</span> <span class="nx">l1</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="nx">l1</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="nx">d</span><span class="o">*</span><span class="nx">l1</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">l1vAngle</span><span class="p">))</span>
    <span class="nv">d1 = </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">beta</span><span class="p">)</span> <span class="o">/</span> <span class="nx">l1</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">l2vAngle</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">)</span>
    <span class="nv">d2 = </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">beta</span><span class="p">)</span> <span class="o">/</span> <span class="nx">l2len</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">l1vAngle</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;d1: #{d1} d2: #{d2}&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">d1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">precision</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">d2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">precision</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;equality found: #{d1}&quot;</span>
      <span class="k">return</span> <span class="p">{</span><span class="nv">t: </span><span class="mi">0</span><span class="p">}</span>
    
    <span class="nv">l1len = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">d</span><span class="o">*</span><span class="nx">d</span> <span class="o">+</span> <span class="nx">l2</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="nx">l2</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="nx">d</span><span class="o">*</span><span class="nx">l2</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">l2vAngle</span><span class="p">))</span>
    <span class="nv">d1 = </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">beta</span><span class="p">)</span> <span class="o">/</span> <span class="nx">l1len</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">l2vAngle</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">)</span>
    <span class="nv">d2 = </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">beta</span><span class="p">)</span> <span class="o">/</span> <span class="nx">l2</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">l1vAngle</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;d1: #{d1} d2: #{d2}&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">d1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">precision</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">d2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">precision</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;equality found: #{d1}&quot;</span>
      <span class="k">return</span> <span class="p">{</span><span class="nv">t: </span><span class="mi">0</span><span class="p">}</span>
        
    <span class="nx">collisions</span><span class="p">.</span><span class="nx">NONE</span>
    
  <span class="nv">isImpendingCollision = </span><span class="nf">(ts) -&gt;</span>
    <span class="mi">0</span> <span class="o">&lt;</span> <span class="nx">ts</span> <span class="o">&lt;=</span> <span class="mi">1</span>
  </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>General purpose collision detection for arbitrary shapes <br />
@param {Shape} s1 - first shape object <br />
@param {Shape} s2 - 2nd shape object <br />
@returns {Array} <br />
  0: {Number} time to collision <br />
  1: {Vector} collision normal</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">detectCollision = </span><span class="nf">(s1, s2) -&gt;</span>
    <span class="k">switch</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">when</span> <span class="s1">&#39;Circle&#39;</span>
        <span class="k">switch</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">name</span>
          <span class="k">when</span> <span class="s1">&#39;Circle&#39;</span>
            <span class="nx">circleCircleCollision</span><span class="p">(</span><span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span><span class="p">)</span>
          <span class="k">when</span> <span class="s1">&#39;Line&#39;</span>
            <span class="nx">circleWallCollision</span><span class="p">(</span><span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Unknown shape: &quot;</span> <span class="o">+</span> <span class="nx">s2</span>
      <span class="k">else</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Unknown shape: &quot;</span> <span class="o">+</span> <span class="nx">s1</span>
  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>resolveInelasticCollisionFree</p>

<p>Sets velocity of 2 objects with any mass after inelastic collision along normal <br />
@params: 2 objects and normal of collision</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveInelasticCollisionFree = </span><span class="nf">(s1, s2, n) -&gt;</span>
    <span class="nv">r = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">mass</span> <span class="err">/ s2.mass</span>
    <span class="nv">u = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
    <span class="nv">e = </span><span class="nx">ob1</span><span class="p">.</span><span class="nx">efficiency</span> <span class="o">*</span> <span class="nx">ob2</span><span class="p">.</span><span class="nx">efficiency</span>
    <span class="nv">un = </span><span class="nx">u</span><span class="p">.</span><span class="nx">component</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="nv">ut = </span><span class="nx">u</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">un</span><span class="p">).</span><span class="nx">x</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">mag</span><span class="p">()</span>
    <span class="nv">sq = </span><span class="nx">r</span><span class="o">*</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">un</span><span class="o">*</span><span class="nx">un</span> <span class="o">-</span> <span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="nx">r</span><span class="o">-</span><span class="nx">e</span><span class="p">)</span> <span class="o">*</span> <span class="nx">un</span><span class="o">*</span><span class="nx">un</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nx">e</span><span class="p">)</span> <span class="o">*</span> <span class="nx">ut</span><span class="o">*</span><span class="nx">ut</span><span class="p">)</span>
    <span class="nv">vn = </span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">sq</span><span class="p">)</span> <span class="o">-</span> <span class="nx">r</span><span class="o">*</span><span class="nx">un</span><span class="p">).</span><span class="nx">div</span><span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">wn = </span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">un</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">vn</span><span class="p">)).</span><span class="nx">x</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="nv">s1.velocity = </span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">vn</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">ut</span><span class="p">))</span>
    <span class="nv">s2.velocity = </span><span class="nx">wn</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>resolveInelasticCollisionFixed</p>

<p>Sets velocity of 2 objects with equal mass after inelastic collision along normal <br />
@params: 2 objects, normal of collision</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveInelasticCollisionFixed = </span><span class="nf">(s1, s2, n) -&gt;</span>
    <span class="nv">e = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">efficiency</span> <span class="o">*</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">efficiency</span>
    <span class="nv">un = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">componentVector</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="nv">ut = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">un</span><span class="p">)</span>
    <span class="nv">sq = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="nv">vn = </span><span class="nx">un</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">x</span><span class="p">(</span><span class="nx">sq</span><span class="p">)</span>
    <span class="nv">s1.velocity = </span><span class="nx">ut</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">vn</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>resolveCollisionFixed</p>

<p>Sets velocity of an object after an elastic collision along normal
@param {Shape} ob colliding object
@param {Vector} n collision along vector</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveCollisionFixed = </span><span class="nf">(ob, n) -&gt;</span>
    <span class="nv">u = </span><span class="nx">ob</span><span class="p">.</span><span class="nx">velocity</span>
    <span class="nx">ob</span><span class="p">.</span><span class="nx">setVelocity</span> <span class="nx">u</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">componentVector</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">x</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>resolveCollisionEqualMass</p>

<p>Sets velocity of 2 objects with equal mass after elastic collision along normal <br />
@params: 2 objects and normal of collision  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveCollisionEqualMass = </span><span class="nf">(s1, s2, n) -&gt;</span>
    <span class="nv">u = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
    <span class="nv">un = </span><span class="nx">u</span><span class="p">.</span><span class="nx">componentVector</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="nv">ut = </span><span class="nx">u</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">un</span><span class="p">)</span>
    <span class="nv">s1.velocity = </span><span class="nx">ut</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
    <span class="nv">s2.velocity = </span><span class="nx">un</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>resolveCollisionFree  </p>

<p>Sets velocity of 2 objects with any mass after elastic collision along normal <br />
@params: 2 objects and normal of collision  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveCollisionFree = </span><span class="nf">(s1, s2, n) -&gt;</span>
    <span class="nv">r = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">mass</span> <span class="err">/ s2.mass</span>
    <span class="nv">base = </span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
    <span class="nv">baseIsZero = </span><span class="nx">base</span><span class="p">.</span><span class="nx">eql</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nv">u = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>If base has zero velocity and objects are the same type, simply switch velocities</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">baseIsZero</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s1</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
        <span class="nv">s2.velocity = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
        <span class="nv">s1.velocity = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="nv">u = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span> <span class="c1"># Sylvester doesn&#39;t like subtracting by zero</span>
    <span class="k">else</span>
      <span class="nv">u = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
      
    <span class="nv">un = </span><span class="nx">u</span><span class="p">.</span><span class="nx">componentVector</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="nv">ut = </span><span class="nx">u</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">un</span><span class="p">)</span>
    <span class="nv">vn = </span><span class="nx">un</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">r</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">divide</span><span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">wn = </span><span class="nx">un</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">r</span><span class="p">).</span><span class="nx">divide</span><span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">ut = </span><span class="nx">ut</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">vn</span><span class="p">)</span>

    <span class="nv">s1.velocity = </span><span class="k">if</span> <span class="nx">baseIsZero</span> <span class="k">then</span> <span class="nx">ut</span> <span class="k">else</span> <span class="nx">ut</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
    <span class="nv">s2.velocity = </span><span class="k">if</span> <span class="nx">baseIsZero</span> <span class="k">then</span> <span class="nx">wn</span> <span class="k">else</span> <span class="nx">wn</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>resolveAngularCollision</p>

<p>Sets velocity and angular velocities after elastic collision
@param {Shape} s1 first object
@param {Shape} s2 other object
@param {Vector} n normal of collision
@param {Vector} mom1 moment vector for s1 
  mom = clockwise normal of the radius vector
@param {Vectory} mom2 moment vector for s2</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveAngularCollision = </span><span class="nf">(s1, s2, n, mom1, mom2) -&gt;</span>
    <span class="nv">u1 = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span>
    <span class="nv">u2 = </span><span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span>
    <span class="nv">om1 = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">angularVelocity</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="nv">om2 = </span><span class="nx">s2</span><span class="p">.</span><span class="nx">angularVelocity</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    
    <span class="nv">J = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">u2</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">u1</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">mom2</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">om2</span><span class="p">)).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">mom1</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">om1</span><span class="p">)).</span><span class="nx">dot</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="nv">denom = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s1</span><span class="p">.</span><span class="nx">isFixedLinear</span><span class="p">()</span>
      <span class="nv">m1 = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">mass</span>
      <span class="nx">denom</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">m1</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s2</span><span class="p">.</span><span class="nx">isFixedLinear</span><span class="p">()</span>
      <span class="nv">m2 = </span><span class="nx">s2</span><span class="p">.</span><span class="nx">mass</span>
      <span class="nx">denom</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">m2</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s1</span><span class="p">.</span><span class="nx">isFixedAngular</span><span class="p">()</span>
      <span class="nv">moi1 = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">MOI</span><span class="p">()</span>
      <span class="nv">dp1 = </span><span class="nx">mom1</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
      <span class="nx">denom</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">dp1</span><span class="o">*</span><span class="nx">dp1</span> <span class="err">/ moi1)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s2</span><span class="p">.</span><span class="nx">isFixedAngular</span><span class="p">()</span>
      <span class="nv">moi2 = </span><span class="nx">s2</span><span class="p">.</span><span class="nx">MOI</span><span class="p">()</span>
      <span class="nv">dp2 = </span><span class="nx">mom2</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
      <span class="nx">denom</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">dp2</span><span class="o">*</span><span class="nx">dp2</span> <span class="err">/ moi2)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">denom</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># coincident axes or weirdness</span>
    
    <span class="nx">J</span> <span class="err">/= denom</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s1</span><span class="p">.</span><span class="nx">isFixedLinear</span><span class="p">()</span>
      <span class="nx">s1</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="nx">u1</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">J</span><span class="p">).</span><span class="nx">div</span><span class="p">(</span><span class="nx">m1</span><span class="p">)))</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s2</span><span class="p">.</span><span class="nx">isFixedLinear</span><span class="p">()</span>
      <span class="nx">s2</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="nx">u2</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">J</span><span class="p">).</span><span class="nx">div</span><span class="p">(</span><span class="nx">m2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s1</span><span class="p">.</span><span class="nx">isFixedAngular</span><span class="p">()</span>
      <span class="nx">s1</span><span class="p">.</span><span class="nx">setAngularVelocity</span><span class="p">(</span><span class="nx">om1</span> <span class="o">+</span> <span class="nx">J</span> <span class="o">*</span> <span class="nx">dp1</span> <span class="err">/ moi1)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">s2</span><span class="p">.</span><span class="nx">isFixedAngular</span><span class="p">()</span>
      <span class="nx">s2</span><span class="p">.</span><span class="nx">setAngularVelocity</span><span class="p">(</span><span class="nx">om2</span> <span class="o">-</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">dp2</span> <span class="err">/ moi2)</span>
  
    
    </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>resolveCollision  </p>

<p>General purpose collision resolution for arbitrary shapes <br />
@param {Shape} s1 - first shape object <br />
@param {Shape} s2 - 2nd shape object <br />
@param {Vector} n - collision normal  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveCollision = </span><span class="nf">(s1, s2, n) -&gt;</span>
    <span class="k">if</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">mass</span> <span class="o">==</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">mass</span>
      <span class="nx">resolveCollisionEqualMass</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span><span class="p">,</span> <span class="nx">n</span>
    <span class="k">else</span>
      <span class="nx">resolveCollisionFree</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span><span class="p">,</span> <span class="nx">n</span>
 </pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Collision detection+resolution on all scene objects
Side effects: moves objects and changes their velocity based  on 
any collision interactions  </p>

<p>@param {Number} timestep since last call <br />
@param {Array} moving objects <br />
@param {Array} fixed objects  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">checkCollisions = </span><span class="nf">(ts, moving, fixed) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>console.log "checkCollisions " + ts</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">mn = </span><span class="mi">2</span>
    <span class="nv">ob1 = ob2 = </span><span class="kc">null</span>
    <span class="nv">n = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nv">collisionNormal = </span><span class="kc">null</span>
    <span class="nv">collisionTime = </span><span class="mi">0</span>
    
    <span class="nv">displacement = </span><span class="nf">(ts, vel) -&gt;</span>
      <span class="nx">vel</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">ts</span> <span class="err">/ 1000.0)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Moves some shape for some timestep</p>

<p>@param {Shape} s - object to move
@param {Number} ts - timestep</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">moveObject = </span><span class="nf">(s, ts) -&gt;</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">move</span> <span class="nx">displacement</span><span class="p">(</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
    
    <span class="nv">detectCollisionHelper = </span><span class="nf">(s1, s2) -&gt;</span>
      <span class="nv">s1.displacement = </span><span class="nx">displacement</span><span class="p">(</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
      <span class="nv">s2.displacement = </span><span class="nx">displacement</span><span class="p">(</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
      
      <span class="p">[</span><span class="nx">collisionTime</span><span class="p">,</span> <span class="nx">collisionNormal</span><span class="p">]</span> <span class="o">=</span> <span class="nx">detectCollision</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span>
      
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">isImpendingCollision</span><span class="p">(</span><span class="nx">collisionTime</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>console.log "collision in " + collisionTime</p>             </td>             <td class="code">               <div class="highlight"><pre>      
      <span class="nv">m = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">mn</span><span class="p">,</span> <span class="nx">collisionTime</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>If collision is most imminent, save objects' info</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">mn</span>
        <span class="nv">mn = </span><span class="nx">m</span>
        <span class="nv">n = </span><span class="nx">collisionNormal</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span>
        <span class="nv">ob1 = </span><span class="nx">s1</span>
        <span class="nv">ob2 = </span><span class="nx">s2</span>
        <span class="nv">s1.collided = s2.collided = </span><span class="kc">true</span>
        
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">moving</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">detectCollisionHelper</span><span class="p">(</span><span class="nx">moving</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">moving</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="k">if</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span>
      </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>now search for collisions with fixed objects</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">fixed</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">detectCollisionHelper</span><span class="p">(</span><span class="nx">moving</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">fixed</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="k">if</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Move objects</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">tmove = </span><span class="k">if</span> <span class="p">(</span><span class="nx">mn</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="nx">ts</span> <span class="k">else</span> <span class="p">(</span><span class="nx">mn</span> <span class="o">*</span> <span class="nx">ts</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">tmove</span> <span class="o">&gt;</span> <span class="nx">Sylvester</span><span class="p">.</span><span class="nx">precision</span>
      <span class="nx">moveObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">tmove</span><span class="p">)</span> <span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">moving</span>
    </pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>if there is no collision we are finished</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="nx">mn</span> <span class="o">==</span> <span class="mi">2</span>
    </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>resolve collisions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">resolveCollision</span> <span class="nx">ob1</span><span class="p">,</span> <span class="nx">ob2</span><span class="p">,</span> <span class="nx">n</span>
    </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>recurse for the next timestep portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">nextts = </span><span class="nx">ts</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">mn</span><span class="p">)</span>
    <span class="nx">checkCollisions</span><span class="p">(</span><span class="nx">nextts</span><span class="p">,</span> <span class="nx">moving</span><span class="p">,</span> <span class="nx">fixed</span><span class="p">)</span> <span class="k">if</span> <span class="nx">nextts</span> <span class="o">&gt;</span> <span class="nx">Sylvester</span><span class="p">.</span><span class="nx">precision</span>
  </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>determine if a point lies inside a circle
@param {Vector} pt point
@param {Circle} circle circle object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pointInCircle = </span><span class="nf">(pt, circle) -&gt;</span>
    <span class="nv">dist = </span><span class="nx">circle</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">pt</span><span class="p">).</span><span class="nx">mag</span><span class="p">()</span>
    <span class="nx">dist</span> <span class="o">&lt;=</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">radius</span>
    </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>determine if a point lies inside a triangle
using alg. from http://www.blackpawn.com/texts/pointinpoly/default.html</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pointInTriangle = </span><span class="nf">(pt, triangle) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>console.log "pointInTriangle pnt #{pt.inspect()}"
console.log "triangle: #{triangle.toString()}"</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">sameSide = </span><span class="nf">(p1, p2, a, b) -&gt;</span>
      <span class="nv">cp1 = </span><span class="nx">b</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">cross</span><span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span>
      <span class="nv">cp2 = </span><span class="nx">b</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">cross</span><span class="p">(</span><span class="nx">p2</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span>
      <span class="nx">cp1</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">cp2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    
    <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">]</span> <span class="o">=</span> <span class="nx">triangle</span><span class="p">.</span><span class="nx">points</span>
    <span class="nx">sameSide</span><span class="p">(</span><span class="nx">pt</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="o">and</span> <span class="nx">sameSide</span><span class="p">(</span><span class="nx">pt</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="o">and</span> <span class="nx">sameSide</span><span class="p">(</span><span class="nx">pt</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
  
  <span class="nv">pointInPolygon = </span><span class="nf">(pt, poly) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Use faster pointInTriangle test if possible</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">pointInTriangle</span><span class="p">(</span><span class="nx">pt</span><span class="p">,</span> <span class="nx">poly</span><span class="p">)</span> <span class="k">if</span> <span class="nx">poly</span><span class="p">.</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">3</span>
    </pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>choose an arbitrary point outside the polygon
set mx to the max x-value in poly</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">vxs = </span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">poly</span><span class="p">.</span><span class="nx">points</span><span class="p">)</span>
    <span class="nv">mx = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="nx">vxs</span><span class="p">...</span>
    <span class="nv">outpoint = </span><span class="nx">$V</span><span class="p">([</span><span class="nx">mx</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    </pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>add beginning point to end for the last line segment</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">poly</span><span class="p">.</span><span class="nx">points</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">poly</span><span class="p">.</span><span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>now count the intersections along the ray from pt to outpoint</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">intersections = </span><span class="mi">0</span>
    <span class="nv">c = </span><span class="nx">poly</span><span class="p">.</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">p1 = </span><span class="nx">poly</span><span class="p">.</span><span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nv">p2 = </span><span class="nx">poly</span><span class="p">.</span><span class="nx">points</span><span class="p">[(</span><span class="nx">i</span><span class="o">%</span><span class="nx">c</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">throw</span> <span class="s2">&quot;error in pointInPolygon for index #{i}&quot;</span> <span class="nx">unless</span> <span class="nx">p1</span><span class="o">?</span> <span class="o">and</span> <span class="nx">p2</span><span class="o">?</span>
      <span class="nv">t = </span><span class="nx">intersection</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">pt</span><span class="p">,</span> <span class="nx">outpoint</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">isImpendingCollision</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>console.log "intersection in #{t} for #{pt.inspect()} in #{p1.inspect()} #{p2.inspect()}"</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">intersections</span> <span class="o">+=</span> <span class="mi">1</span>
    </pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>if number of intersections is odd, then point is inside polygon </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">(</span><span class="nx">intersections</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Return public functions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">{</span><span class="nx">checkCollisions</span>
  <span class="nx">detectCollision</span>
  <span class="nx">circleWallCollision</span>
  <span class="nx">isImpendingCollision</span>
  <span class="nx">resolveCollision</span>
  <span class="nx">resolveCollisionFixed</span>
  <span class="nx">resolveInelasticCollisionFixed</span>
  <span class="nx">angularCollisionLineCircle</span>
  <span class="nx">angularCollisionLineCircle2</span>
  <span class="nx">angularCollisionLineStationaryLine</span>
  <span class="nx">angularCollisionLineLine</span>
  <span class="nx">pointInCircle</span>
  <span class="nx">pointInTriangle</span> 
  <span class="nx">pointInPolygon</span><span class="p">}</span>
<span class="p">)()</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>constants</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">collisions.NONE     = </span><span class="o">-</span><span class="mi">1</span>
<span class="nv">collisions.EMBEDDED = </span><span class="o">-</span><span class="mi">2</span>

<span class="nv">root = </span><span class="nx">exports</span> <span class="o">?</span> <span class="nb">window</span>
<span class="nv">root.collisions = </span><span class="nx">collisions</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 